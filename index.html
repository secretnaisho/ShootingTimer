
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clap Reaction Trainer</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 24px; }
    .card { max-width: 560px; margin: 0 auto; }
    button { font-size: 18px; padding: 12px 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .big { font-size: 44px; font-weight: 700; margin: 16px 0; }
    .status { padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; }
    .flash {
      position: fixed; inset: 0; background: #fff; opacity: 0;
      pointer-events: none; transition: opacity 80ms linear;
    }
    .flash.on { opacity: 1; }
    input[type="range"]{ width: 240px; }
    .muted { color:#666; font-size: 13px; }
  </style>
</head>
<body>
  <div class="flash" id="flash"></div>

  <div class="card">
    <h1>ğŸ‘ ç°¡æ˜“å‹ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¤ãƒãƒ¼</h1>

    <div class="row">
      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>

    <p class="status" id="status">Ready.</p>
    <div class="big" id="time">--.--</div>

    <div class="row">
      <label>Clap sensitivity</label>
      <input id="threshold" type="range" min="0.02" max="0.30" step="0.01" value="0.10">
      <span id="thrVal">0.10</span>
    </div>
    <p class="muted">
      iPhoneã¯æœ€åˆã«ã€ŒStartã€ã‚’æŠ¼ã—ã¦ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™ã€‚åå¿œãŒæ—©ã™ãã‚‹/é…ã™ãã‚‹æ™‚ã¯æ„Ÿåº¦ã‚’èª¿æ•´ã€‚
    </p>
  </div>

<script>
(() => {
  const startBtn = document.getElementById("startBtn");
  const stopBtn  = document.getElementById("stopBtn");
  const statusEl = document.getElementById("status");
  const timeEl   = document.getElementById("time");
  const flashEl  = document.getElementById("flash");
  const thr      = document.getElementById("threshold");
  const thrVal   = document.getElementById("thrVal");

  thr.addEventListener("input", () => thrVal.textContent = Number(thr.value).toFixed(2));

  let audioCtx, analyser, data;
  let listening = false;
  let armed = false;
  let startedAt = 0;
  let rafId = 0;
  let preTimer = 0;
  let lockoutUntil = 0;

  function now() { return performance.now(); }

  function flash(ms=120) {
    flashEl.classList.add("on");
    setTimeout(() => flashEl.classList.remove("on"), ms);
  }

  function beep() {
    // å°ã•ãªãƒ“ãƒ¼ãƒ—éŸ³ï¼ˆä»»æ„ï¼‰ã€‚iOSã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œãªã‚‰é³´ã‚Šã¾ã™
    if (!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = 880;
    g.gain.value = 0.05;
    o.connect(g).connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + 0.08);
  }

  async function initAudio() {
    if (audioCtx) return;

    const stream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
    });

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    data = new Uint8Array(analyser.fftSize);
    src.connect(analyser);
  }

  function rmsFromTimeDomain() {
    analyser.getByteTimeDomainData(data);
    let sum = 0;
    for (let i = 0; i < data.length; i++) {
      const v = (data[i] - 128) / 128; // -1..1
      sum += v * v;
    }
    return Math.sqrt(sum / data.length);
  }

  function loop() {
    if (!listening) return;

    const level = rmsFromTimeDomain();
    const threshold = Number(thr.value);

    // åå¿œé–‹å§‹å‰ï¼ˆãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿä¸­ï¼‰ã¯èª¤æ¤œçŸ¥ã—ãªã„
    if (armed && now() > lockoutUntil && level > threshold) {
      stopWithTime(now() - startedAt);
      return;
    }

    rafId = requestAnimationFrame(loop);
  }

  function stopWithTime(ms) {
    armed = false;
    listening = false;
    cancelAnimationFrame(rafId);
    clearTimeout(preTimer);

    stopBtn.disabled = true;
    startBtn.disabled = false;

    const sec = ms / 1000;
    timeEl.textContent = sec.toFixed(2);
    statusEl.textContent = `Clap detected! Reaction: ${sec.toFixed(2)}s`;
  }

  function resetUI(msg="Ready.") {
    statusEl.textContent = msg;
    timeEl.textContent = "--.--";
  }

  startBtn.addEventListener("click", async () => {
    try {
      resetUI("Requesting microphone permission...");
      await initAudio();

      // iOSå¯¾ç­–ï¼šAudioContextãŒsuspendedãªã‚‰resume
      if (audioCtx.state === "suspended") await audioCtx.resume();

      startBtn.disabled = true;
      stopBtn.disabled = false;

      // 0ã€œ10ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ
      const delay = Math.random() * 10000;
      statusEl.textContent = `Wait... (${(delay/1000).toFixed(2)}s max)`;

      listening = true;
      armed = false;
      cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(loop);

      preTimer = setTimeout(() => {
        // åˆå›³ï¼
        flash(140);
        beep();
        startedAt = now();

        // åˆå›³ç›´å¾Œã®èª¤æ¤œçŸ¥ã‚’é¿ã‘ã‚‹ãŸã‚ã€çŸ­ã„ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆ0.12ç§’ï¼‰
        lockoutUntil = startedAt + 120;
        armed = true;
        statusEl.textContent = "GO! Clap once!";
      }, delay);

    } catch (e) {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      resetUI("Microphone error. Browser permission or unsupported device.");
      console.error(e);
    }
  });

  stopBtn.addEventListener("click", () => {
    armed = false;
    listening = false;
    cancelAnimationFrame(rafId);
    clearTimeout(preTimer);
    stopBtn.disabled = true;
    startBtn.disabled = false;
    resetUI("Stopped.");
  });
})();
</script>
</body>
</html>